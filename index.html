<!DOCTYPE html>
<html>
<head>
  <title>Risk Management Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geosearch/dist/bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; display: flex; }
    #map { height: 100vh; width: 70%; }
    #data-panel {
      width: 30%;
      padding: 10px;
      overflow-y: auto;
      background: white;
      box-shadow: -2px 0 5px rgba(0,0,0,0.3);
    }
    /* Chart container style to limit vertical space and allow scrolling */
    #chartContainer {
      max-height: 800px;
      overflow-y: auto;
    }
    /* Position the search container on the left below the zoom controls */
    #search-container {
      position: absolute;
      top: 70px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 1000;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="data-panel">
    <h3>Click a country or hospital to see details</h3>
    <div id="country-data"></div>
  </div>
  <div id="search-container">
    <input type="text" id="country-search" placeholder="Search for a location" 
           onkeyup="if(event.key==='Enter') searchLocation()">
    <button onclick="searchLocation()">Search</button>
  </div>

  <script>
    // Base map layers
    var osmStandard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });
    var osmHot = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors, Tiles courtesy of HOT'
    });
    var darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; CartoDB, OpenStreetMap contributors'
    });
    var satelliteMap = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      attribution: '&copy; Google Maps',
      subdomains: ['mt0','mt1','mt2','mt3']
    });
    
    var map = L.map('map', {
      center: [20, 0],
      zoom: 2,
      layers: [osmHot]
    });
    
    var baseMaps = {
      "Standard OSM": osmStandard,
      "Humanitarian OSM": osmHot,
      "Dark Map": darkMap,
      "Satellite View": satelliteMap
    };

    // Unified display function with two charts
    function displayData(props) {
      var container = document.getElementById("country-data");
      container.innerHTML = ""; // Clear previous content

      if (props.Disaster_Info && Array.isArray(props.Disaster_Info)) {
        // Create a container for both charts
        var chartContainer = document.createElement("div");
        chartContainer.id = "chartContainer";

        // Create first canvas for disaster count chart
        var canvas1 = document.createElement("canvas");
        canvas1.id = "chartCanvas1";

        // Create second canvas for people affected chart
        var canvas2 = document.createElement("canvas");
        canvas2.id = "chartCanvas2";

        chartContainer.appendChild(canvas1);
        chartContainer.appendChild(canvas2);
        container.appendChild(chartContainer);

        // Aggregate data arrays
        var labels = [];
        var counts = [];
        var peopleAffected = [];
        props.Disaster_Info.forEach(function(d) {
          labels.push(d.Type);
          counts.push(d.Count);
          peopleAffected.push(parseInt(d["People Affected Since 2000"].replace(/,/g, ""), 10));
        });

        // First chart: Disaster Count since 2000
        var ctx1 = canvas1.getContext('2d');
        new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Disaster Count since 2000',
              data: counts,
              backgroundColor: 'rgba(255, 120, 0, 0.6)',
              borderColor: 'rgba(255, 120, 0, 1)',
              borderWidth: 1
            }]
          },
          options: {
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  maxRotation: 90,
                  minRotation: 90
                }
              },
              y: {
                beginAtZero: true
              }
            },
            plugins: {
              title: {
                display: true,
                text: (props.Country ? props.Country + " (" + props.ISO + ")" : "Disaster Data")
              }
            }
          }
        });

        // Second chart: Total people affected since 2000
        var ctx2 = canvas2.getContext('2d');
        new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Total people affected since 2000',
              data: peopleAffected,
              backgroundColor: 'rgba(0, 120, 255, 0.6)',
              borderColor: 'rgba(0, 120, 255, 1)',
              borderWidth: 1
            }]
          },
          options: {
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  maxRotation: 90,
                  minRotation: 90
                }
              },
              y: {
                beginAtZero: true
              }
            },
            plugins: {
              title: {
                display: true,
                text: (props.Country ? props.Country + " (" + props.ISO + ")" : "People Affected Data")
              }
            }
          }
        });
      } 
      // Hospital data branch (for Sudan health data)
      else if (props["#loc+amenity"] || props["#meta+healthcare"] || props["#loc +name"]) {
        var title = props["#loc +name"] || "Hospital";
        container.innerHTML = "<h3>" + title + "</h3>" +
          "<p>Amenity: " + (props["#loc+amenity"] || "N/A") + "</p>" +
          "<p>Healthcare: " + (props["#meta+healthcare"] || "N/A") + "</p>";
      } 
      else if (props.Country) {
        container.innerHTML = "<h3>" + props.Country + "</h3><p>No detailed disaster data available.</p>";
      } 
      else if (props.name) {
        container.innerHTML = "<h3>" + props.name + "</h3>";
      } 
      else {
        container.innerHTML = "<p>No data available</p>";
      }
    }

    // Build lookup table using ISO codes from disaster data
    var emdatDataByISO = {};

    // EMDAT disaster data layer: add all features but render point features invisibly
    var emdatLayer = L.geoJSON(null, {
      pointToLayer: function(feature, latlng) {
        // Render points invisibly to build lookup without cluttering the map
        return L.circleMarker(latlng, { radius: 0, opacity: 0, fillOpacity: 0 });
      },
      onEachFeature: function(feature, layer) {
        layer.on("click", function() {
          displayData(feature.properties);
        });
      }
    }).addTo(map);

    // Hospital data (Sudan health) layer with custom hospital icon
    var healthIcon = L.icon({
      iconUrl: 'https://img.icons8.com/fluency/48/000000/hospital-2.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
    
    var sudanLayer = L.geoJSON(null, {
      pointToLayer: function(feature, latlng) {
        return L.marker(latlng, { icon: healthIcon });
      },
      onEachFeature: function(feature, layer) {
        layer.on("click", function() {
          displayData(feature.properties);
        });
      }
    }).addTo(map);

    // Countries boundaries layer (polygons only, no markers)
    var countriesLayer = L.geoJSON(null, {
      filter: function(feature) {
        return feature.geometry.type !== "Point";
      },
      style: function(feature) {
        return { color: "transparent", weight: 0, fillOpacity: 0 };
      },
      onEachFeature: function(feature, layer) {
        layer.on("click", function() {
          // Use iso_a3 property if available; otherwise fallback to feature.id
          var iso = feature.properties.iso_a3 || feature.id;
          if (iso && emdatDataByISO[iso.toLowerCase()]) {
            displayData(emdatDataByISO[iso.toLowerCase()]);
          } else {
            var countryName = feature.properties.name;
            displayData({ Country: countryName });
          }
        });
      }
    }).addTo(map);

    // Add overlay layers to layer control
    L.control.layers(baseMaps, {
      "EMDAT Data": emdatLayer,
      "Sudan HXL": sudanLayer,
      "Countries": countriesLayer
    }).addTo(map);

    // Search function: search for any location using Nominatim
    function searchLocation() {
      var query = document.getElementById("country-search").value.trim();
      if (!query) {
        alert("Please enter a location.");
        return;
      }
      var encodedQuery = encodeURIComponent(query);
      fetch("https://nominatim.openstreetmap.org/search?q=" + encodedQuery + "&format
