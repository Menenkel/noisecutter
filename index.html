<!DOCTYPE html>
<html>
<head>
  <title>Risk Management Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geosearch/dist/bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; display: flex; }
    #map { height: 100vh; width: 75%; }
    #data-panel {
      width: 25%;
      padding: 10px;
      overflow-y: auto;
      background: white;
      box-shadow: -2px 0 5px rgba(0,0,0,0.3);
      font-size: 14px;
      line-height: 1.5;
    }
    /* Position the search container on the left below the zoom controls */
    #search-container {
      position: absolute;
      top: 70px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 1000;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="data-panel">
    <h3>Click a country or hospital to see details</h3>
    <div id="country-data"></div>
  </div>
  <div id="search-container">
    <input type="text" id="country-search" placeholder="Search for a country" onkeyup="if(event.key==='Enter') searchCountry()">
    <button onclick="searchCountry()">Search</button>
  </div>

  <script>
    // Base map layers
    var osmStandard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' });
    var osmHot = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors, Tiles courtesy of Humanitarian OpenStreetMap Team' });
    var darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB, OpenStreetMap contributors' });
    var satelliteMap = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { attribution: '&copy; Google Maps', subdomains: ['mt0','mt1','mt2','mt3'] });
    
    var map = L.map('map', {
      center: [20, 0],
      zoom: 2,
      layers: [osmHot]
    });
    
    var baseMaps = {
      "Standard OSM": osmStandard,
      "Humanitarian OSM": osmHot,
      "Dark Map": darkMap,
      "Satellite View": satelliteMap
    };

    // Unified display function
    function displayData(props) {
      var content = "";
      if (props.Disaster_Info && Array.isArray(props.Disaster_Info)) {
        content += `<h3>${props.Country} (${props.ISO})</h3>`;
        props.Disaster_Info.forEach(function(d) {
          var affectedRaw = d["People Affected Since 2000"] || "0";
          var affected = parseInt(affectedRaw.replace(/,/g, ""), 10).toLocaleString();
          content += `<p>Type: ${d.Type}</p>`;
          content += `<p>Count: ${d.Count}</p>`;
          content += `<p>Affected: ${affected}</p>`;
          content += `<hr>`;
        });
      } else if (props.Country) {
        content += `<h3>${props.Country}</h3>`;
        content += `<p>No detailed disaster data available.</p>`;
      } else if (props.name) {
        content += `<h3>${props.name}</h3>`;
      } else {
        content = "<p>No data available</p>";
      }
      document.getElementById("country-data").innerHTML = content;
    }

    // Build lookup table using ISO codes
    var emdatDataByISO = {};

    // EMDAT disaster data layer (only polygons; filter out Point features)
    var emdatLayer = L.geoJSON(null, {
      filter: function(feature) {
        return feature.geometry.type !== "Point";
      },
      style: function(feature) {
        return { color: "#ff7800", weight: 1, fillOpacity: 0.4 };
      },
      onEachFeature: function(feature, layer) {
        layer.on("click", function() {
          displayData(feature.properties);
        });
      }
    }).addTo(map);

    // Hospital data (Sudan health) layer with custom hospital icon
    var healthIcon = L.icon({
      iconUrl: 'https://img.icons8.com/fluency/48/000000/hospital-2.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
    
    var sudanLayer = L.geoJSON(null, {
      pointToLayer: function(feature, latlng) {
        return L.marker(latlng, { icon: healthIcon });
      },
      onEachFeature: function(feature, layer) {
        layer.on("click", function() {
          displayData(feature.properties);
        });
      }
    }).addTo(map);

    // Countries boundaries layer (polygons only, no markers)
    var countriesLayer = L.geoJSON(null, {
      filter: function(feature) {
        return feature.geometry.type !== "Point";
      },
      style: function(feature) {
        return { color: "transparent", weight: 0, fillOpacity: 0 };
      },
      onEachFeature: function(feature, layer) {
        layer.on("click", function() {
          // Use iso_a3 if available, otherwise fallback to feature.id
          var iso = feature.properties.iso_a3 || feature.id;
          if (iso && emdatDataByISO[iso.toLowerCase()]) {
            displayData(emdatDataByISO[iso.toLowerCase()]);
          } else {
            var countryName = feature.properties.name;
            displayData({ Country: countryName });
          }
        });
      }
    }).addTo(map);

    // Add overlay layers to layer control
    L.control.layers(baseMaps, {
      "EMDAT Data": emdatLayer,
      "Sudan HXL": sudanLayer,
      "Countries": countriesLayer
    }).addTo(map);

    // Country search using Nominatim
    function searchCountry() {
      var country = document.getElementById("country-search").value.trim();
      if (!country) {
        alert("Please enter a country name.");
        return;
      }
      var encodedCountry = encodeURIComponent(country);
      fetch(`https://nominatim.openstreetmap.org/search?country=${encodedCountry}&format=json&limit=1`)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            var boundingBox = data[0].boundingbox.map(Number);
            var southWest = L.latLng(boundingBox[0], boundingBox[2]);
            var northEast = L.latLng(boundingBox[1], boundingBox[3]);
            var bounds = L.latLngBounds(southWest, northEast);
            map.fitBounds(bounds);
          } else {
            alert("Country not found. Try a different name.");
          }
        })
        .catch(error => {
          console.error("Error fetching location:", error);
          alert("Failed to retrieve location. Try again later.");
        });
    }

    // Load EMDAT disaster data and build lookup table by ISO codes
    fetch("https://menenkel.github.io/noisecutter/EMDAT_20Mar2025.json")
      .then(response => response.json())
      .then(data => {
        emdatLayer.clearLayers();
        emdatLayer.addData(data);
        data.features.forEach(function(feature) {
          var iso = feature.properties.ISO;
          if (iso) {
            emdatDataByISO[iso.toLowerCase()] = feature.properties;
          }
        });
      })
      .catch(error => console.error("Error loading Disaster GeoJSON:", error));

    // Load Sudan health data
    fetch("https://menenkel.github.io/noisecutter/sudan_hxl.json")
      .then(response => response.json())
      .then(data => {
        sudanLayer.clearLayers();
        sudanLayer.addData(data);
      })
      .catch(error => console.error("Error loading Sudan HXL GeoJSON:", error));

    // Load country boundaries from a public source
    fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
      .then(response => response.json())
      .then(data => {
        countriesLayer.clearLayers();
        countriesLayer.addData(data);
      })
      .catch(error => console.error("Error loading countries GeoJSON:", error));
  </script>
</body>
</html>
